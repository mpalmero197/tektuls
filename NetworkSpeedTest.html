<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Network Speed Test</title>
  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<canvas id="networkSpeedChart" style="width: 400px; height: 200px;"></canvas>
<p id="current-speed">Current Speed: -- Mbps</p>

<script>
let networkSpeedData = [];
const ctx = document.getElementById('networkSpeedChart').getContext('2d');
const myChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: Array(10).fill(''),
    datasets: [{
      label: 'Speed (Mbps)',
      data: networkSpeedData,
      borderWidth: 1
    }]
  },
  options: { responsive: true, animation: false }
});

async function measureNetworkSpeed() {
  try {
    // Replace with YOUR exact GitHub Pages link
    const response = await fetch('https://mpalmero197.github.io/tektuls/10MB.bin', {
      cache: 'no-cache',
      mode: 'cors'
    });
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const reader = response.body.getReader();

    let totalBytes = 0;
    const startTime = performance.now();
    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      totalBytes += value.length;
    }
    const endTime = performance.now();
    const timeSec = (endTime - startTime) / 1000;
    const bits = totalBytes * 8;
    const speedBps = bits / timeSec;
    const speedMbps = (speedBps / (1024 * 1024)).toFixed(2);
    return speedMbps;
  } catch (e) {
    console.error(e);
    return null;
  }
}

async function updateChart() {
  const speed = await measureNetworkSpeed();
  const speedDisplay = document.getElementById('current-speed');
  if (speed !== null) {
    networkSpeedData.push(speed);
    if (networkSpeedData.length > 10) networkSpeedData.shift();
    myChart.data.datasets[0].data = networkSpeedData;
    myChart.update();
    speedDisplay.textContent = `Current Speed: ${speed} Mbps`;
  } else {
    speedDisplay.textContent = 'Current Speed: -- Mbps';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  updateChart(); // do it once
  // setInterval(updateChart, 10000); // uncomment to run every 10s
});
</script>
</body>
</html>
